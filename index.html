<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>My Grist Chart Widget</title>
    <!-- Include Plotly.js library -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <link href="style.css" rel="stylesheet">
  </head>

  <body>
    test

    <div class="container">
      <div class="timeline">
        <div class="start"></div>
      </div>
      <div class="entries">
        <div class="entry project">
          <div class="dot"></div>
          <div class="label">
            <div class="time">April 2013</div>
            <div class="detail">
              Launched <a href="https://youtube.com/charbytes">Charbytes</a>
            </div>
          </div>
        </div>
        <div class="entry study">
          <div class="dot"></div>
          <div class="label">
            <div class="time">September 2012</div>
            <div class="detail">Began Silversmithing degree @ London Met</div>
          </div>
        </div>
        <div class="entry project">
          <div class="dot"></div>
          <div class="label">
            <div class="time">July 2012</div>
            <div class="detail">
              Launched
              <a href="http://pentatopejewellery.com">Pentatope</a> Jewellery
            </div>
          </div>
        </div>
        <div class="entry study">
          <div class="dot"></div>
          <div class="label">
            <div class="time">September 2011</div>
            <div class="detail">
              Started Foundation degree @ Central Saint Martins
            </div>
          </div>
        </div>
        <div class="entry life">
          <div class="dot"></div>
          <div class="label">
            <div class="time">June 2011</div>
            <div class="detail">Left School</div>
          </div>
        </div>
        <div class="entry project">
          <div class="dot"></div>
          <div class="label">
            <div class="time">May 2010</div>
            <div class="detail">
              Released first tumblr theme
              <a
                href="http://pouretrebelle.com/post/563994536/ive-made-my-first-real-theme"
                title="no this is really bad don't click on it"
                >Belle</a
              >
            </div>
          </div>
        </div>
        <div class="entry project">
          <div class="dot"></div>
          <div class="label">
            <div class="time">September 2009</div>
            <div class="detail">
              Started
              <a href="http://pouretrebelle.com">Pour &Ecirc;tre Belle</a>
            </div>
          </div>
        </div>
        <div class="entry life">
          <div class="dot"></div>
          <div class="label">
            <div class="time">November 2005</div>
            <div class="detail">Moved To Bath</div>
          </div>
        </div>
        <div class="entry life">
          <div class="dot"></div>
          <div class="label">
            <div class="time">July 1993</div>
            <div class="detail">Born In Buckinghamshire</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Wait for the Grist API to be ready
      grist.ready({
        columns: ["Evenement", "Statut", "Description", "Date"],
        requiredAccess: "read table",
      });

      const plotDiv = document.getElementById("myDiv");

      // Set the height and width of the Plotly chart to match the iframe
      const layout = {
        title: {
          automargin: true,
        },
        legend: {
          xanchor: "right",
          yanchor: "top",
          bgcolor: "rgba(0,0,0,0.15)",
          font: {
            size: 10,
          },
        },
        autosize: true,
        yaxis: {
          tickmode: "auto",
        },
        margin: {
          l: 30,
          r: 5,
          t: 5,
          pad: 0,
        },
      };

      const config = {
        displayModeBar: false, // this is the line that hides the bar.
        responsive: true,
      };

      // When a new record is selected in the Grist table, render a chart based on its data
      grist.onRecords(function (records, mappings) {
        let mapped = grist.mapColumnNames(records);
        if (mapped) {
          // mJson = mapped Json from mapped column
          let mResults = mapped.map(({ Result, Date }) => ({ Result, Date }));
          let mTargets = mapped.map(({ Target, Date }) => ({ Target, Date }));
          let mMeans = mapped.map(({ Mean, Date }) => ({ Mean, Date }));
          // sorting by Date
          mTargets.sort((a, b) => {
            return a.Date - b.Date;
          });
          mMeans.sort((a, b) => {
            return a.Date - b.Date;
          });

          let traceResult = {
            x: mResults.map((obj) => obj.Date),
            y: mResults.map((obj) => obj.Result),
            type: "bar",
            name: "Résultats",
            opacity: 0.7,
            marker: {
              color: "rgba(184,184,184,0.6)",
            },
          };
          let traceTarget = {
            x: mTargets.map((obj) => obj.Date),
            y: mTargets.map((obj) => obj.Target),
            type: "scatter",
            name: "Objectif",
          };

          let traceMean = {
            x: mMeans.map((obj) => obj.Date),
            y: mMeans.map((obj) => obj.Mean),
            type: "line",
            name: "12 Mois Glissants",
          };

          let data = [traceResult, traceTarget, traceMean];
          Plotly.newPlot("myDiv", data, layout, config);
        } else {
          // Helper returned a null value. It means that not all
          // required columns were mapped.
          console.error("Please map all columns");
        }
      });
    </script>
  </body>
</html>
